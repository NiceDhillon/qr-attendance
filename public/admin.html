<!DOCTYPE html>
<html>
<head>
  <title>Admin - Generate QR</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
  <h2>Generate QR</h2>

  <button onclick="generate()">Generate QR</button>

  <div class="info" id="status"></div>
  <div class="timer" id="timer"></div>

  <img id="qr">
</div>

<script>
let countdownInterval;

function generate() {
  document.getElementById("status").innerText = "Fetching location...";

  navigator.geolocation.getCurrentPosition(pos => {
    fetch("/generate-qr", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        lat: pos.coords.latitude,
        lon: pos.coords.longitude,
        accuracy: pos.coords.accuracy
      })
    })
    .then(r => r.json())
    .then(d => {
      document.getElementById("qr").src = d.qr;
      document.getElementById("status").innerText =
        `QR Generated\nExpires at: ${d.expiresAt}`;

      startTimer(120); // 2 minutes
    });
  });
}

function startTimer(seconds) {
  clearInterval(countdownInterval);

  const timerDiv = document.getElementById("timer");
  let remaining = seconds;

  countdownInterval = setInterval(() => {
    const min = Math.floor(remaining / 60);
    const sec = remaining % 60;

    timerDiv.innerText = `Auto-download in ${min}:${sec.toString().padStart(2, "0")}`;

    if (remaining <= 0) {
      clearInterval(countdownInterval);
      timerDiv.innerText = "Session ended. Downloading CSV...";
      autoDownloadCSV();
    }

    remaining--;
  }, 1000);
}

function autoDownloadCSV() {
  // Trigger CSV download
  window.location.href = "/download";
}
</script>

</body>
</html>
