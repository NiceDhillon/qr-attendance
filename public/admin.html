<!DOCTYPE html>
<html>
<head>
  <title>Admin - QR Attendance</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
  <h2>Generate QR</h2>

  <button onclick="generateQR()">Generate QR</button>

  <p id="info"></p>
  <p id="notice" style="color:red;font-weight:bold;"></p>

  <img id="qr" style="display:none">

  <br><br>
  <button id="downloadBtn" style="display:none" onclick="downloadCSV()">
    Download Attendance CSV
  </button>
</div>

<script>
let poller = null;

function generateQR() {
  document.getElementById("notice").innerText = "";
  document.getElementById("downloadBtn").style.display = "none";

  navigator.geolocation.getCurrentPosition(pos => {
    fetch("/generate-qr", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        lat: pos.coords.latitude,
        lon: pos.coords.longitude,
        accuracy: pos.coords.accuracy
      })
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById("qr").src = data.qr;
      document.getElementById("qr").style.display = "block";

      document.getElementById("info").innerHTML = `
        QR Generated: ${data.generatedAt}<br>
        Expires At: ${data.expiresAt}
      `;

      startPolling();
    });
  });
}

function startPolling() {
  clearInterval(poller);

  poller = setInterval(async () => {
    const res = await fetch("/session-status");
    const data = await res.json();

    if (!data.active) {
      document.getElementById("notice").innerText =
        "Session ended. Attendance closed.";
      document.getElementById("downloadBtn").style.display = "inline-block";
      clearInterval(poller);
    }
  }, 1000);
}

function downloadCSV() {
  window.location.href = "/download";
}
</script>

</body>
</html>
